name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Restore
        run: dotnet restore

      - name: Build
        run: |
          VERSION_NUM="${GITHUB_REF_NAME#v}"
          DOT_COUNT=$(grep -o "\\." <<< "$VERSION_NUM" | wc -l || true)
          if [[ "$DOT_COUNT" -eq 2 ]]; then
            BUILD_VERSION="${VERSION_NUM}.0"
          else
            BUILD_VERSION="${VERSION_NUM}"
          fi
          dotnet build -c Release -p:Version=${BUILD_VERSION}
          echo "VERSION=${VERSION_NUM}" >> "$GITHUB_ENV"
          echo "BUILD_VERSION=${BUILD_VERSION}" >> "$GITHUB_ENV"

      - name: Package
        run: |
          set -euo pipefail
          mkdir -p dist/package
          cp -R src/Jellyfin.Plugin.PlaylistsPlus/bin/Release/net8.0/* dist/package/
          (cd dist/package && zip -r ../Jellyfin.Plugin.PlaylistsPlus_v${VERSION}.zip .)

      - name: Checkout main for manifest update
        run: |
          set -euo pipefail
          git fetch origin main
          git checkout main
          git pull --rebase origin main

      - name: Update manifest
        run: |
          set -euo pipefail
          python3 - <<'PY'
          import datetime
          import hashlib
          import json
          import os

          version = os.environ["VERSION"]
          build_version = os.environ["BUILD_VERSION"]
          tag = f"v{version}"
          repo = os.environ["GITHUB_REPOSITORY"]
          zip_path = f"dist/Jellyfin.Plugin.PlaylistsPlus_v{version}.zip"

          with open(zip_path, "rb") as f:
              checksum = hashlib.md5(f.read()).hexdigest().upper()

          source_url = f"https://github.com/{repo}/releases/download/{tag}/Jellyfin.Plugin.PlaylistsPlus_v{version}.zip"
          changelog = f"https://github.com/{repo}/releases/tag/{tag}"
          timestamp = datetime.datetime.utcnow().date().isoformat()

          manifest_path = "manifest.json"
          with open(manifest_path, "r", encoding="utf-8") as f:
              manifest = json.load(f)

          guid = "b9b9a50f-8b3a-4d2a-9c0e-7e2d0d7c2d73"
          plugin = next((p for p in manifest if p.get("guid") == guid), None)
          if plugin is None:
              raise SystemExit("Plugin GUID not found in manifest.json")

          versions = plugin.get("versions", [])
          versions = [v for v in versions if v.get("version") != build_version]
          versions.insert(0, {
              "version": build_version,
              "changelog": changelog,
              "targetAbi": "10.10.3.0",
              "sourceUrl": source_url,
              "checksum": checksum,
              "timestamp": timestamp
          })
          plugin["versions"] = versions

          with open(manifest_path, "w", encoding="utf-8") as f:
              json.dump(manifest, f, indent=2)
              f.write("\n")
          PY

      - name: Commit manifest
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add manifest.json
          if git diff --cached --quiet; then
            echo "No manifest changes to commit."
            exit 0
          fi
          git commit -m "Update manifest for ${GITHUB_REF_NAME}"
          git push origin HEAD:main

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/Jellyfin.Plugin.PlaylistsPlus_v${{ env.VERSION }}.zip
